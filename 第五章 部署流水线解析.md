# 什么是部署流水线
  + 是指软件从版本控制库到用户手中这一过程的自动化表现形式（提交到版本控制库，经过各种测试和部署，再发布到用户手中）
  ### 流水线各个阶段：
   1. 提交阶段：从技术角度上断言整个系统是可以工作的。进行编译，自动化测试 (主要是单元测试)，代码分析等等。
   2. 自动化验收测试阶段：从功能和非功能角度上断言整个系统是可以工作的，满足用户的需要（比如e2e测试？）。
   3. 手工测试阶段：用于断言系统是可用的。发现缺陷，并验证系统是否为用户提供了价值。这一阶段通常包括探索性测试、ST测试以及UAT测试。
    4. 发布阶段：部署到生产环境（或以套装软件的形式），或试运行环境，到用户手中。
 ### 最基本的流水线
![image.png](https://upload-images.jianshu.io/upload_images/9584440-24a2e71d2bebd948.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

# 部署流水线的相关实践
 - 只生成一次二进制包：
    1.两个重要原则：保证部署流水线的高效性（编译需要花很长时间）；始终在已知可靠的基础上进行构建（多次创建二进制包可能会不一样）
    2. 应该只在构建流水线的提交阶段生成一次。
    3. 对于不需要编译的语言，二进制包指的是所有源文件的集合。
    4. 这些二进制包应保存在文件系统的某个位置，让流水线后续阶段能够轻松访问到，但不要放在版本控制库中。
    5. 二进制包应与环境无关。
-  对不同环境采用同一部署方式
    1. 使用属性文件保存配置信息。为每个环境保存一个属性文件，并将其放在版本控制库中，如果环境中有多台服务器，可以将环境变量提供给部署脚本
    2. 将配置放在一个服务或数据库中(比如阿波罗？)
-   对部署进行冒烟测试
    1. 要启动应用程序，检查一下，能看到主页面，并在主页面上能看到正确的内容，所依赖的服务等等
- 向生产环境的副本中部署（开发测试环境与生产环境有差异）
    1. 为了对系统上线充满信心，你要尽可能在与生产环境相似的环境中进行测试和持续集成。
    2. 理想情况下，如果生产环境非常简单，可以建立生产环境一模一样的环境，用于运行手工测试或自动化测试。
- 每次变更都要立即在流水线中传递
- 只要有环节失败，就停止整个流水线

# 提交阶段
- 步骤
  1. 编译
  2. 提交测试（但单元测试，容易失败的特定测试）
  3. 创建二进制包
  4. 代码分析
- 提交阶段度量，不达标提交失败
  1. 测试覆盖率
  2. 重复代码，圈复杂度等等

# 自动化验收测试之门
 - 提交完成后，立即做验收测试，简单的验收测试为：运行代码，查看主页。（e2e测试？）

# 后续测试阶段
- 测试人员根据自己的需求将任意一个版本部署到自己测试环境中

- 手工测试：测试人员会做一些机器不太擅长而人比较擅长的测试。他们做探索性测试、易用性测试等
- 非功能测试

# 发布准备
- 把发布环节视为部署流水线的一个自然结果，缓解发布风险
- 需要如下做：
   1. 让参与项目交付过程的人共同创建并维护一个发布计划；
  2. 通过尽可能多的自动化过程最小化人为错误发生的可能性，并从最容易出错的
环节开始实现自动化；
  3. 在类生产环境中经常做发布流程演练，这样就可以对这个流程及其所使用的技
术进行调试；
  4. 如果事情并没有按计划执行，要有撤销某次发布的能力；
  5. 作为升级和撤销过程的一部分，制定配置迁移和数据迁移的策略。

### 自动部署与发布
- 对生产环境的任何修改都应该通过自动化过程完成【程序的部署，配置，软件栈，网络拓扑，状态的所有修改）
- 管理生产环境的流程，也应用于测试环境
- 使用虚拟化技术，最佳配置管理

###变更的撤销策略
- 让旧版本仍处于可用状态，保持一段时间
- 从头开始部署旧版本
###在成功基础上构建

# 实现一个部署流水线
- 使用增量方法来实现部署流水线。
- 步骤
  1. 对价值流建模，并创建一个可工作的简单框架；
  2. 将构建和部署流程自动化：构建过程的输入是源代码，输出结果是二进制包
  3. 将单元测试和代码分析自动化；
  4.  将验收测试自动化；
  5. 将发布自动化。

# 度量
- 对于软件交付过程来说，最重要的全局度量指标就是周期时间
- 利用约束理论优化周期时间。
  1. 识别系统中的约束，也就是瓶颈。
  2.  确保供应，即确保最大限度地提高流程中这部分的产出。
  3. 根据这一约束调整其他环节的产出。
  4. 为约束环节扩容。
  5. 理顺约束环节并重复上述步骤


笔记参考：
1. 持续交付：发布可靠软件的系统方法
2. https://www.jianshu.com/p/24168d346621 作者：潘晓华Michael


